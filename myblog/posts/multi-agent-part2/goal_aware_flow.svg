<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 940" font-family="system-ui, -apple-system, sans-serif">
  <!-- Arrowhead markers (defined first) -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748B"/>
    </marker>
    <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#F59E0B"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="700" height="940" fill="#ffffff"/>

  <!-- Title -->
  <text x="350" y="30" text-anchor="middle" font-size="18" font-weight="600" fill="#1a1a1a">Goal-Aware Agent Flow</text>

  <!-- User Request -->
  <rect x="290" y="50" width="120" height="40" rx="20" fill="#F1F5F9" stroke="#64748B" stroke-width="2"/>
  <text x="350" y="75" text-anchor="middle" font-size="12" font-weight="500" fill="#1a1a1a">User Request</text>

  <!-- Arrow to Synthesizer -->
  <path d="M350 90 L350 110" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Synthesizer -->
  <rect x="150" y="115" width="400" height="70" rx="6" fill="#E8F4FD" stroke="#1DA1F2" stroke-width="2"/>
  <text x="170" y="140" font-size="13" font-weight="600" fill="#1a1a1a">SYNTHESIZER</text>
  <text x="170" y="158" font-size="10" fill="#666666">• Analyzes first request for parallelism (called ONCE)</text>
  <text x="170" y="173" font-size="10" fill="#666666">• Delegates to DispatcherPool</text>
  <text x="540" y="175" font-size="9" fill="#1DA1F2" font-style="italic" text-anchor="end">[Entry Point]</text>

  <!-- Arrow to Dispatcher Pool -->
  <path d="M350 185 L350 205" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Dispatcher Pool Container -->
  <rect x="40" y="210" width="620" height="530" rx="8" fill="#FAFAFA" stroke="#CBD5E1" stroke-width="2"/>
  <text x="60" y="235" font-size="14" font-weight="600" fill="#1a1a1a">DISPATCHER POOL</text>

  <!-- Task Creation Section -->
  <rect x="60" y="250" width="580" height="85" rx="6" fill="#FEF3C7" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="80" y="272" font-size="11" font-weight="600" fill="#92400E">TASK CREATION (initial + every handoff/fan_out)</text>

  <!-- LLM Intent Router -->
  <rect x="80" y="282" width="280" height="40" rx="4" fill="#FDE68A" stroke="#F59E0B" stroke-width="1.5"/>
  <text x="95" y="300" font-size="10" font-weight="500" fill="#1a1a1a">LLM Intent Router</text>
  <text x="95" y="314" font-size="9" fill="#666666">"Which agent?" → routed_to="X"</text>

  <!-- Arrow from router to task -->
  <path d="M360 302 L400 302" stroke="#F59E0B" stroke-width="1.5" marker-end="url(#arrowhead-orange)"/>

  <!-- Create Task -->
  <rect x="405" y="282" width="220" height="40" rx="4" fill="#FDE68A" stroke="#F59E0B" stroke-width="1.5"/>
  <text x="420" y="300" font-size="10" font-weight="500" fill="#1a1a1a">Create Task</text>
  <text x="420" y="314" font-size="9" fill="#666666">{ routed_to, goal, intent, state }</text>

  <!-- Arrow to Queue -->
  <path d="M350 335 L350 355" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Task Queue (highlighted as central hub) -->
  <rect x="120" y="360" width="460" height="55" rx="6" fill="#DCFCE7" stroke="#22C55E" stroke-width="3"/>
  <text x="350" y="383" text-anchor="middle" font-size="13" font-weight="600" fill="#166534">TASK QUEUE</text>
  <text x="350" y="400" text-anchor="middle" font-size="10" fill="#166534">Event-driven • Zero polling • Central hub for all tasks</text>

  <!-- Loop back arrow (from bottom, goes around right side to Task Creation top center) -->
  <path d="M600 720 L655 720 L655 235 L350 235 L350 240" stroke="#22C55E" stroke-width="2" fill="none" stroke-linejoin="round"/>
  <polygon points="345,240 355,240 350,250" fill="#22C55E"/>

  <!-- Arrow to Agent Watchers -->
  <path d="M350 415 L350 440" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <text x="360" y="432" font-size="9" fill="#666666" font-style="italic">event: "task available!"</text>

  <!-- Agent Watchers -->
  <rect x="180" y="445" width="340" height="50" rx="6" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="2"/>
  <text x="350" y="467" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1a1a">AGENT WATCHERS (all wake up)</text>
  <text x="350" y="483" text-anchor="middle" font-size="10" fill="#666666">routed_to == me? → Only ONE agent claims task</text>

  <!-- Arrow to Agent Execution -->
  <path d="M350 495 L350 515" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Agent Execution -->
  <rect x="100" y="520" width="480" height="100" rx="6" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="2"/>
  <text x="120" y="543" font-size="12" font-weight="600" fill="#1a1a1a">AGENT EXECUTION</text>

  <text x="120" y="562" font-size="10" fill="#666666">1. validate_assignment() → REJECT? Handoff │ ACCEPT? continue</text>
  <text x="120" y="578" font-size="10" fill="#666666">2. execute_autonomous(goal, state) → Call services directly</text>
  <text x="120" y="594" font-size="10" fill="#666666">3. _reason_about_goal() → "Is the user's goal satisfied?"</text>
  <text x="570" y="610" font-size="9" fill="#8B5CF6" font-style="italic" text-anchor="end">[Goal-Aware]</text>

  <!-- Arrow to outcomes -->
  <path d="M350 620 L350 645" stroke="#64748B" stroke-width="1.5"/>

  <!-- Three outcome boxes -->
  <!-- Complete -->
  <rect x="100" y="650" width="120" height="45" rx="6" fill="#DCFCE7" stroke="#22C55E" stroke-width="2"/>
  <text x="160" y="670" text-anchor="middle" font-size="11" font-weight="600" fill="#166534">COMPLETE</text>
  <text x="160" y="685" text-anchor="middle" font-size="9" fill="#166534">Goal satisfied</text>

  <!-- Handoff -->
  <rect x="250" y="650" width="120" height="45" rx="6" fill="#FEF3C7" stroke="#F59E0B" stroke-width="2"/>
  <text x="310" y="670" text-anchor="middle" font-size="11" font-weight="600" fill="#92400E">HANDOFF</text>
  <text x="310" y="685" text-anchor="middle" font-size="9" fill="#92400E">Next agent needed</text>

  <!-- Fan Out -->
  <rect x="400" y="650" width="140" height="45" rx="6" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
  <text x="470" y="668" text-anchor="middle" font-size="11" font-weight="600" fill="#DC2626">FAN_OUT</text>
  <text x="470" y="682" text-anchor="middle" font-size="8" fill="#DC2626">Run tasks in parallel</text>
  <text x="470" y="692" text-anchor="middle" font-size="8" fill="#DC2626">Merge results when done</text>

  <!-- Lines from decision point to outcomes -->
  <path d="M350 645 L160 650" stroke="#64748B" stroke-width="1.5"/>
  <path d="M350 645 L310 650" stroke="#64748B" stroke-width="1.5"/>
  <path d="M350 645 L470 650" stroke="#64748B" stroke-width="1.5"/>

  <!-- Arrows from handoff/fan_out to loop back -->
  <path d="M310 695 L310 720" stroke="#F59E0B" stroke-width="1.5"/>
  <path d="M470 695 L470 720" stroke="#EF4444" stroke-width="1.5"/>

  <!-- Connector line joining handoff and fan_out paths -->
  <path d="M310 720 L600 720" stroke="#22C55E" stroke-width="2" stroke-linecap="round"/>

  <!-- Arrow from complete to outside -->
  <path d="M160 695 L160 755" stroke="#22C55E" stroke-width="1.5"/>
  <polygon points="160,765 155,755 165,755" fill="#22C55E"/>

  <!-- End of Dispatcher Pool -->

  <!-- Synthesizer response -->
  <rect x="80" y="770" width="240" height="50" rx="6" fill="#E8F4FD" stroke="#1DA1F2" stroke-width="2"/>
  <text x="200" y="790" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1a1a">SYNTHESIZER</text>
  <text x="200" y="807" text-anchor="middle" font-size="9" fill="#666666">Format final result for user</text>

  <!-- Arrow to result -->
  <path d="M200 820 L200 840" stroke="#64748B" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Result -->
  <rect x="140" y="845" width="120" height="35" rx="17" fill="#F1F5F9" stroke="#64748B" stroke-width="2"/>
  <text x="200" y="868" text-anchor="middle" font-size="12" font-weight="500" fill="#1a1a1a">User Result</text>

  <!-- Legend -->
  <rect x="450" y="770" width="190" height="105" rx="6" fill="#F8FAFC" stroke="#E2E8F0" stroke-width="1"/>
  <text x="465" y="790" font-size="10" font-weight="600" fill="#1a1a1a">Legend</text>
  <rect x="465" y="800" width="12" height="12" fill="#DCFCE7" stroke="#22C55E" stroke-width="1"/>
  <text x="485" y="810" font-size="9" fill="#666666">Queue / Complete</text>
  <rect x="465" y="818" width="12" height="12" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1"/>
  <text x="485" y="828" font-size="9" fill="#666666">Routing / Handoff</text>
  <rect x="465" y="836" width="12" height="12" fill="#FEE2E2" stroke="#EF4444" stroke-width="1"/>
  <text x="485" y="846" font-size="9" fill="#666666">Fan Out (Parallel)</text>
  <rect x="465" y="854" width="12" height="12" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="1"/>
  <text x="485" y="864" font-size="9" fill="#666666">Agent Execution</text>

</svg>
